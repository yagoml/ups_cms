var extend=function(a,b){function c(){this.constructor=a}for(var d in b)hasProp.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a},hasProp={}.hasOwnProperty;define(["jquery","underscore","backbone",ENV+"/js/router",ENV+"/js/components/autoCrud/dataTable",ENV+"/js/components/autoCrud/newData",ENV+"/js/components/autoCrud/editData",ENV+"/js/components/autoCrud/dataFilters",ENV+"/js/components/autoCrud/inputTypes",ENV+"/js/components/loader","text!src/templates/components/autoCrud/autoCrud.html","text!src/templates/components/autoCrud/newDataTpl.html","text!src/templates/components/autoCrud/editDataTpl.html","text!lib/fine-uploader/templates/gallery.html","text!lib/fine-uploader/templates/simple-thumbnails.html","text!src/templates/components/upload/upload.html","lib/fine-uploader/jquery.fine-uploader.min","lib/jquery-ui-sortable/jquery-ui.min"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){var q,r,s;return r=baseUrl+"dados/",s=new j({class:"mLoader"}),loadCss(baseUrl+"lib/fine-uploader/fine-uploader-new.min.css"),loadCss(baseUrl+"lib/fine-uploader/fine-uploader-gallery.min.css"),loadCss(baseUrl+"lib/jquery-ui-sortable/jquery-ui.min.css"),loadCss(baseUrl+ENV+"/css/components/autoCrud.css"),q=function(){function b(){}return b.addOrder=function(b){return a.ajax({method:"POST",dataType:"json",url:baseUrl+"dados/addOrder",data:{table:b.table,id:b.model.get(b.pk),data:b.model.attributes}})},b.subOrder=function(b){return a.ajax({method:"POST",dataType:"json",url:baseUrl+"dados/subOrder",data:{table:b.table,id:b.model.get(b.pk),data:b.model.attributes}})},b.setOrder=function(b){return a.ajax({method:"POST",dataType:"json",url:baseUrl+"dados/setOrder",data:{table:b.table,id:b.model.get(b.pk),data:b.model.attributes,ordem:b.ordem}})},b}(),function(j){function l(){return l.__super__.constructor.apply(this,arguments)}return extend(l,j),l.prototype.className="auto-crud",l.prototype.template=b.template(k),l.prototype.qtdDados=20,l.prototype.events={"click #newData":"openNewData","click #filtrarDados":"openWindowdataFilters","click #removerFiltro":"removerFiltro","click #deleteData":"deleteList","click #backGrid":"backGrid","click #deleteDataEdit":"deleteDataEdit","sortupdate .qq-upload-list":"dragFile","click .qq-thumbnail-selector":"openFile"},l.prototype.resetPaginationControls=function(){return this.paginationControls={limiteBuscaAtingido:!1,requisicaoAtiva:!1,paginaAtual:1}},l.prototype.initialize=function(e){return this.options=e,this.defCmsAccessTables=this.getCmsTables(),this.defAllowAccess=a.Deferred(),this.configSite="config_site"===this.options.table,this.filesCollection=!1,this.resetPaginationControls(),a.when(this.defCmsAccessTables).done(function(e){return function(){var f;if(f=e.options,e.table=f.table,e.filterID=f.filterID,e.edit=f.edit,e.newData=f.newData,e.parentTable=f.parentTable,e.pk=f.pk,e.fk=f.fk,e.allowAcess=b.findWhere(e.cmsAccessTables,{table:e.table})||null!=e.fk,e.allowAcess){if(!e.edit&&e.configSite)return;e.renderizeTable=e.options.renderTable||!0,e.collection=new c.Collection,e.checkedModels=new c.Collection,e.collection.url=r,e.colFetchDef=a.Deferred(),e.colFetchDef.promise(),e.tableInfos=e.getTableInfos(),e.defFetchData=a.Deferred(),e.defFetchData.promise(),e.newData?a.when.apply(a,[e.getTableTitles(),e.getFKs(),e.getSystemFields()]).done(function(a){return e.colFetchDef.resolve(),e.openNewData()}):e.filesCollection=!0}else d.navigate("#admin");return e.defAllowAccess.resolve()}}(this))},l.prototype.getCmsTables=function(){return a.ajax({type:"post",dataType:"json",url:baseUrl+"tableInfos/cmsTables",success:function(a){return function(b){a.cmsAccessTables=b}}(this)})},l.prototype.prepareCollection=function(){return this.pk=b.findWhere(this.tableInfos,{primary_key:1}).name,this.edit?(this.$("#newData").show(),this.configSite&&this.$("#buttonsArea").remove(),a.when.apply(a,[this.defItemData=this.getItemData(this.filterID),this.getTableTitles(),this.getFKs()]).done(function(a){return function(b){return a.editModel=b,a.colFetchDef.resolve(),a.openEditData(b)}}(this))):(this.filterID?null!=this.fk?this.fetchData={table:this.table,fk:this.fk,filterID:this.filterID,pagina:0}:this.fetchData={table:this.table,pk:this.pk,filterID:this.filterID,pagina:0}:this.fetchData={table:this.table,pagina:0},this.defFetchData.resolve(),this.collection.fetch({data:this.fetchData,success:function(b){return function(){return b.colFetchDef.resolve(),b.showQtdDados(),b.checkForFilesTable(b.tableInfos)?(b.filesCollectionUpload(),b.$("#newData").hide()):(b.$("#newData").show(),b.renderizeTable?a.when.apply(a,[b.getTableTitles(),b.getFKs()]).done(function(){return b.createTable(),b.delegateEvents()}):void 0)}}(this)})),this.collection.on("update",this.updateRegCounter,this),this.editing=!1},l.prototype.delegateEvents=function(){return l.__super__.delegateEvents.apply(this,arguments),null!=this.crudTableView&&(this.crudTableView.delegateEvents(),this.listenTo(this.crudTableView,"openEditData",this.openEditData),this.listenTo(this.crudTableView,"itemChecked",this.interactExcBtn),this.listenTo(this.crudTableView,"removeData",this.deletarDado),this.listenTo(this.crudTableView,"dadosSolicitados",this.nextScrollPage),this.listenTo(this.crudTableView,"addOrder",this.addOrder),this.listenTo(this.crudTableView,"subOrder",this.subOrder)),this.$("#dataTableContent .table-responsive").on("scroll",function(a){return function(b){return a.scroll()}}(this))},l.prototype.undelegateEvents=function(){if(l.__super__.undelegateEvents.apply(this,arguments),null!=this.crudTableView)return this.crudTableView.undelegateEvents(),this.stopListening(this.crudTableView,"openEditData"),this.stopListening(this.crudTableView,"itemChecked"),this.stopListening(this.crudTableView,"removeData"),this.stopListening(this.crudTableView,"addOrder"),this.stopListening(this.crudTableView,"subOrder")},l.prototype.render=function(){return a.when(this.defAllowAccess).done(function(b){return function(){if(b.allowAcess&&(b.autoCrudEL=b.template({table:b.table,gurmetTable:b.allowAcess.name||capitalize(b.table.replace(/(?![a-zA-Z0-9])./g," ")),parentTable:b.parentTable?b.parentTable:void 0,filterID:b.parentTable?b.filterID:void 0}),b.$el.html(b.autoCrudEL),b.$("#dataTableContent").html(s.show()),b.filesCollection))return a.when.apply(a,[b.tableInfos,b.getSystemFields()]).done(function(){return b.prepareCollection()})}}(this)),this},l.prototype.openEditData=function(b){return this.editModel=b,this.edit=!0,a.when.apply(a,[this.colFetchDef,this.tableInfos,this.getRefTables()]).done(function(a){return function(){var e;return b instanceof c.Model||(b=a.collection.findWhere((e={},e[""+a.pk]=b,e))),d.navigate("admin/autoCrud/"+a.table+"/edit/"+b.get(a.pk),{trigger:!1}),a.editData=new g({model:b,table:a.table,tableInfos:a.tableInfos,tableTitles:a.tableTitles,systemFields:a.systemFields,inputTypes:i,fks:a.fks,pk:a.pk,refTables:a.refTables,parentTable:a.parentTable,configSite:a.configSite}),a.$("#dataTableContent").html(a.editData.render().$el),a.editData.afterRender(),a.listenTo(a.editData,"backFromEdit",a.renderTable.bind(a)),a.$("#backGrid").removeClass("hidden"),a.$("#deleteData").hide(),a.$("#deleteDataEdit").show()}}(this))},l.prototype.getItemData=function(b){var d;return d=a.Deferred(),a.ajax({type:"get",dataType:"json",url:baseUrl+"dados",data:{table:this.table,pk:this.pk,filterID:this.filterID,orderBy:this.configSite?"":void 0},success:function(a){return function(a){return d.resolve(new c.Model(a[0]))}}()}),d.promise()},l.prototype.openNewData=function(b){return a.when.apply(a,[this.colFetchDef,this.tableInfos,this.getRefTables()]).done(function(a){return function(){return null!=a.fk?d.navigate("admin/autoCrud/"+a.parentTable+"/related/"+a.table+"/"+a.fk+"/"+a.filterID+"/new",{trigger:!1}):d.navigate("admin/autoCrud/"+a.table+"/new",{trigger:!1}),a.newData=new f({model:new c.Model,table:a.table,tableInfos:a.tableInfos,tableTitles:a.tableTitles,systemFields:a.systemFields,inputTypes:i,fks:a.fks,pk:a.pk,refTables:a.refTables,parentTable:a.parentTable,fk:null!=a.fk?a.fk:void 0,filterID:null!=a.filterID?a.filterID:void 0}),a.listenTo(a.newData,"backFromEdit",a.renderTable.bind(a)),a.$("#dataTableContent").html(a.newData.render().$el),a.newData.afterRender(),a.$("#backParent").removeClass("hidden"),a.$("#newData").hide(),a.$("#deleteData").hide()}}(this))},l.prototype.openWindowdataFilters=function(){return this.windowdataFilters=new h({model:this.model}),this.stopListening(this.windowdataFilters),this.listenTo(this.windowdataFilters,"eventoFiltrado",this.filtrarDados.bind(this)),this.$("#dataTableContent").append(this.windowdataFilters.render())},l.prototype.addDado=function(a){var b;return this.endTableLoader("show"),b=(new Dado).set(a).attributes,this.collection.create(b,{wait:!0,success:function(a){return function(b){return a.crudTableView.addLinha(b),a.endTableLoader("hide")}}(this)})},l.prototype.editDado=function(a){var b;return this.crudTableView.loaderLinha(a.id_evento),b=(new Dado).set(a).attributes,this.model.save(b,{wait:!0,success:function(a){return function(){return a.crudTableView.editLinha(b)}}(this)})},l.prototype.filtrarDados=function(c){return a.ajax({url:baseUrl+"dados/filtro",type:"POST",dataType:"json",data:c,success:function(a){return function(d){return a.collection=new Dados,b.each(d,function(b){return a.collection.models.push((new Dado).set(b))}),a.createTable(),a.renderfiltroAplicado(c)}}(this)})},l.prototype.deletarDado=function(c){var d,e;return d=a.Deferred(),e=[],b.each(c,function(a){return function(b){var c;return c=b.get(a.pk),e.push(c)}}(this)),a.ajax({type:"POST",data:{table:this.table,ids:e,pk:this.pk},url:r+"removeData",success:function(a){return function(){return a.collection.remove(c),d.resolve()}}(this)}),d.promise()},l.prototype.deleteList=function(){var c;if(c=this.checkedModels.models.length,window.confirm("Deseja realmente excluir "+(c>1?"os "+c+" registros selecionados":" o registro #"+b.first(this.checkedModels.models).get(this.pk))+"? Todos os dados relacionados serão excluídos também."))return a.when(this.deletarDado(this.checkedModels.models)).done(function(a){return function(){var b,d;if(a.crudTableView.removeLines(a.checkedModels.models),a.checkedModels.reset(),b=a.$("#deleteData"),b.find("#qntSelectedItens").empty(),b.hide(),c>=20){for(d=1;d>=0;d--)a.nextScrollPage(a.paginationControls.paginaAtual);a.ultimaPosicaoScroll=0}return a.crudTableView.$("#dadosSelectAll")[0].checked=!1,a.crudTableView.selectAllState=!1}}(this))},l.prototype.createTable=function(){return this.$("#dataTableContent").html(s.show()),this.crudTableView=new e({dados:this.collection,systemFields:this.systemFields,tableTitles:null!=this.tableTitles?this.tableTitles:void 0,pk:this.pk,fk:null!=this.fk?this.fk:void 0,fks:this.fks}),this.$("#dataTableContent").html(this.crudTableView.render().$el),this.crudTableView.ellipsisTableData()},l.prototype.renderTable=function(c){var e;if(null==c&&(c={}),!this.configSite){if(null!=this.fk?d.navigate("admin/autoCrud/"+this.parentTable+"/related/"+this.table+"/"+this.fk+"/"+this.filterID,{trigger:!1}):d.navigate("admin/autoCrud/"+this.table,{trigger:!1}),null!=this.crudTableView)a("#panelContent").html(this.$el),this.$("#dataTableContent").css({"margin-top":"0"}),this.$("#dataTableContent").html(this.crudTableView.$el),this.fk||this.$("#backParent").addClass("hidden"),this.$("#backGrid").addClass("hidden"),this.$(".table-responsive").find(".loader-wrapper").remove(),this.$("#deleteDataEdit").hide(),b.isEmpty(c)||(e=this.collection.findIndex(c),e>=0?(this.editing=!0,this.collection.models[e]=c,this.crudTableView.updateLinha(c)):(this.editing=!1,this.collection.add(c))),this.delegateEvents();else{if(this.resetPaginationControls(),a("#panelContent").html(this.render().$el),!this.edit&&this.configSite)return;this.collection.fetch({data:{pagina:0,table:this.table},success:function(a){return function(){return a.createTable(),a.showQtdDados(),a.delegateEvents()}}(this)})}return this.defFetchData.resolve(),this.$("#newData").show()}},l.prototype.getTableTitles=function(){return a.ajax({type:"POST",dataType:"json",url:baseUrl+"tableInfos/titles",data:{table:this.table},success:function(a){return function(b){a.tableTitles=b}}(this)})},l.prototype.endTableLoader=function(a){return this.crudTableView.endTableLoader(a)},l.prototype.tableLoader=function(a){return"show"===a?this.$("#dataTableContent").prepend(s.show()):this.$("#dataTableContent").children(".loader-wrapper").remove()},l.prototype.renderfiltroAplicado=function(a){var c;return c=[],this.$("#titleFiltro").css("display","block"),a.id_evento.length>0&&c.push("ID Dado: <span class='pad5 alert-info'>"+a.id_evento+"</span>"),a.tipo.length>0&&c.push("Tipo contém: <span class='pad5 alert-info'>"+a.tipo+"</span>"),b.each(c,function(a){return function(b){return a.$("#filtroInfos").append("<li>"+b+"</li>")}}(this))},l.prototype.removerFiltro=function(){return this.$("#dataTableContent").html(s.show()),this.initialize(),this.$("#titleFiltro").css("display","none"),this.$("#filtroInfos").html("")},l.prototype.showQtdDados=function(){return this.$("#qtdDados").html(this.collection.models.length)},l.prototype.getDataPage=function(d){return a.ajax({type:"get",dataType:"json",url:baseUrl+"dados",data:this.fetchData,success:function(a){return function(d){return d.length?(b.each(d,function(b){var d;return d=(new c.Model).set(b),a.collection.add(d)}),a.crudTableView.ellipsisTableData()):a.paginationControls.limiteBuscaAtingido=!0}}(this)})},l.prototype.getTableInfos=function(){return a.ajax({type:"POST",dataType:"json",url:baseUrl+"tableInfos",data:{table:this.table},success:function(a){return function(b){return a.tableInfos=b.fieldsData,a.tableFks=b.fksData}}(this)})},l.prototype.getFKs=function(){return a.ajax({type:"POST",dataType:"json",url:baseUrl+"tableInfos/fks",success:function(a){return function(b){a.fks=b}}(this)})},l.prototype.getSystemFields=function(){return a.ajax({type:"POST",dataType:"json",url:baseUrl+"tableInfos/systemFields",success:function(a){return function(b){a.systemFields=b}}(this)})},l.prototype.getRefTables=function(){return a.ajax({type:"post",dataType:"json",url:baseUrl+"tableInfos/getTableFKs",data:{table:this.table},success:function(a){return function(b){a.refTables=b}}(this)})},l.prototype.filesCollectionUpload=function(){var a;return this.$("#dataTableContent").html(p),b.any(this.collection.models)&&(a=this.getFieldDirectory(this.collection.models[0])),this.$("#fine-uploader-manual-trigger").fineUploader({autoUpload:!1,multiple:!0,template:"qq-template-manual-trigger",session:{endpoint:r+"?table="+this.table+"&fk="+this.fk+"&pk="+this.pk+"&filterID="+this.filterID+(null!=a?"&fieldDir="+a:"")},deleteFile:{enabled:!0,endpoint:r+"deleteFile",method:"POST",params:{table:this.table,fieldDir:null!=a?a:void 0}},request:{endpoint:r+"upload",params:{fk:this.fk,id:this.filterID,table:this.table}},thumbnails:{placeholders:{waitingPath:baseUrl+"/lib/fine-uploader/placeholders/waiting-generic.png",notAvailablePath:baseUrl+"/lib/fine-uploader/placeholders/not_available-generic.png"}},callbacks:{onError:function(a,b,c,d){return alert(JSON.parse(d.response).error)},onSessionRequestComplete:function(a){return function(){}}()}}),this.$("#trigger-upload").click(function(a){return function(){return a.$("#fine-uploader-manual-trigger").fineUploader("uploadStoredFiles")}}(this)),this.activeSortFiles()},l.prototype.activeSortFiles=function(){var a;return a=this.$(".qq-upload-list"),a.sortable({axis:"y"}),a.disableSelection()},l.prototype.checkForFilesTable=function(){return b.find(this.tableInfos,function(a){return function(a,b){return"uuid"===a.name}}())},l.prototype.getFieldDirectory=function(a){var c;return c="",b.map(a.attributes,function(a){return function(b,d){if(a.isFileDirectory(b))return c=d}}(this)),c},l.prototype.isFileDirectory=function(a){var b;return b=new RegExp("uploads/","ig"),b.test(a)},l.prototype.interactExcBtn=function(a){var c;return b.each(a,function(a){return function(b){return b.get("checked")?a.checkedModels.add(b):a.checkedModels.remove(b)}}(this)),c=this.$("#deleteData"),this.checkedModels.models.length?(c.show(),c.find("#qntSelectedItens").html(this.checkedModels.models.length)):c.hide()},l.prototype.updateRegCounter=function(a){if(!this.editing)return null!=this.crudTableView&&(this.crudTableView.addLinha(b.last(a.models)),this.crudTableView.ellipsisTableData()),this.$("#qtdDados").html(this.collection.models.length)},l.prototype.backGrid=function(){var a;return this.resetGridStatus(),this.configSite?window.location.hash="admin":(a=null!=this.fk?"admin/autoCrud/"+this.parentTable+"/related/"+this.table+"/"+this.fk+"/"+this.filterID:"admin/autoCrud/"+this.table,d.navigate(a,{trigger:!1}),this.filterID=null,this.renderTable(),this.$("#deleteDataEdit").hide(),b.any(this.checkedModels.models)&&this.$("#deleteData").show()),this.defFetchData.resolve()},l.prototype.deleteDataEdit=function(){if(window.confirm("Deseja realmente excluir o registro #"+this.editData.model.get(this.pk)+"? Todos os dados relacionados serão excluídos também."))return this.deletarDado([this.editData.model]),this.backGrid()},l.prototype.nextScrollPage=function(b){var c;return this.tableLoader("show"),c=this.$("#dataTableContent").children(".table-responsive"),this.paginationControls.requisicaoAtiva=!0,this.paginationControls.paginaAtual++,this.ultimaPosicaoScroll=c.scrollTop(),a.when(this.defFetchData).done(function(c){return function(){return null!=c.fetchData?c.fetchData.pagina=b:c.fetchData={table:c.table,pagina:1},a.when(c.getDataPage()).done(function(){return c.paginationControls.requisicaoAtiva=!1,c.tableLoader("hide")})}}(this))},l.prototype.scroll=function(){var a,b;if(!this.paginationControls.limiteBuscaAtingido&&!this.paginationControls.requisicaoAtiva&&(b=this.$("#dataTableContent > .table-responsive"),a=this.$(".dadosTable"),b.scrollTop()+b.height()>=a.height()-50))return this.nextScrollPage(this.paginationControls.paginaAtual)},l.prototype.resetGridStatus=function(){return this.edit=!1,this.newData=null,this.resetPaginationControls()},l.prototype.addOrder=function(a){return q.addOrder({model:a,table:this.table,pk:this.pk})},l.prototype.subOrder=function(a){return q.subOrder({model:a,table:this.table,pk:this.pk})},l.prototype.dragFile=function(c,d){var e;return e=this.$(".qq-upload-list").children().length,b.each(this.$(".qq-upload-list > li"),function(b){return function(c,d){var f,g,h;return f=a(c),h=f.attr("qq-file-id"),g=e-d,q.setOrder({model:b.collection.at(h),table:b.table,pk:b.pk,ordem:g})}}(this))},l.prototype.openFile=function(b){var c,d,e,f;return this.edit?(d=this.getFieldDirectory(this.editModel),window.open(this.editModel.get(d),"blank")):(c=a(b.target),e=c.closest("li").attr("qq-file-id"),f=this.collection.at(e),window.open(f.get(this.getFieldDirectory(f)),"blank"))},l}(c.View)});